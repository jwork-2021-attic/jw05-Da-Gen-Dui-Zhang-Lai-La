<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayScreen.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">game</a> &gt; <a href="index.source.html" class="el_package">screen</a> &gt; <span class="el_source">PlayScreen.java</span></div><h1>PlayScreen.java</h1><pre class="source lang-java linenums">/*
 * Copyright (C) 2015 Aeranythe Echosong
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License
 * as published by the Free Software Foundation; either version 2
 * of the License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, write to the Free Software
 * Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.
 */
package screen;
import java.util.Random;
import world.*;
import asciiPanel.AsciiPanel;
import java.awt.Color;
import java.awt.event.KeyEvent;
import java.util.ArrayList;
import java.util.List;
/**
 *
 * @author Aeranythe Echosong
 */
public class PlayScreen implements Screen {
    private World world;
    private Player player;
    private int screenWidth;
    private int screenHeight;
    private List&lt;String&gt; messages;
    private List&lt;String&gt; oldMessages;
<span class="nc" id="L37">    int saveHp=0;</span>
<span class="nc" id="L38">    int saveAttack=0;</span>
<span class="nc" id="L39">    int saveDefense=0;</span>
<span class="nc" id="L40">    int saveExp=0;</span>
<span class="nc" id="L41">    int saveMoney=0;</span>
    int saveX;
    int saveY;
<span class="nc" id="L44">    int countTime=0;</span>
<span class="nc" id="L45">    public PlayScreen() {</span>
<span class="nc" id="L46">        this.screenWidth = 30;</span>
<span class="nc" id="L47">        this.screenHeight = 20;</span>
<span class="nc" id="L48">        createWorld();</span>
<span class="nc" id="L49">        this.messages = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L50">        this.oldMessages = new ArrayList&lt;String&gt;();</span>

<span class="nc" id="L52">        CreatureFactory creatureFactory = new CreatureFactory(this.world);</span>
<span class="nc" id="L53">        createCreatures(creatureFactory);</span>

<span class="nc" id="L55">    }</span>


    private void createCreatures(CreatureFactory creatureFactory) {
<span class="nc" id="L59">        this.player = (Player) creatureFactory.newPlayer(this.messages);</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">        for (int i = 0; i &lt; 3; i++) {</span>
<span class="nc" id="L61">            creatureFactory.newShrem(this.messages);</span>
<span class="nc" id="L62">            creatureFactory.newBat(this.messages);</span>
<span class="nc" id="L63">            creatureFactory.newSkeleton(this.messages);</span>
<span class="nc" id="L64">            creatureFactory.newBull(messages);</span>
<span class="nc" id="L65">            creatureFactory.newDragon(messages);</span>
          
        }   
<span class="nc" id="L68">        creatureFactory.newDiamond(messages);</span>
<span class="nc" id="L69">            new Thread(     //循环生成怪物，时间越长怪物越多越强</span>
<span class="nc" id="L70">            ()-&gt;{</span>
<span class="nc" id="L71">                    while (true){</span>
                        try {
<span class="nc" id="L73">                            Thread.sleep(10000);</span>
<span class="nc" id="L74">                        } catch (InterruptedException e) {</span>
<span class="nc" id="L75">                            e.printStackTrace();</span>
                        }
<span class="nc" id="L77">                            countTime++;    </span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                            for(int i=0;i&lt;2;i++){</span>
<span class="nc" id="L79">                            Random rand = new Random();</span>
<span class="nc" id="L80">                            int level=rand.nextInt(30)+countTime;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                            if(level&lt;=10)</span>
<span class="nc" id="L82">                            creatureFactory.newShrem(this.messages);</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">                            else if(level&lt;=20)</span>
<span class="nc" id="L84">                            creatureFactory.newBat(this.messages);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                            else if(level&lt;=30)</span>
<span class="nc" id="L86">                            creatureFactory.newSkeleton(this.messages);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                            else if(level&lt;=40)</span>
<span class="nc" id="L88">                            creatureFactory.newBull(this.messages);</span>
                            else 
<span class="nc" id="L90">                            creatureFactory.newDragon(this.messages);</span>
                            }
                    }
            }
<span class="nc" id="L94">        ).start();</span>

<span class="nc" id="L96">        new Thread(     //每隔一段时间生成宝石</span>
<span class="nc" id="L97">        ()-&gt;{</span>
<span class="nc" id="L98">                while (true){</span>
                    try {
<span class="nc" id="L100">                        Thread.sleep(40000);</span>
<span class="nc" id="L101">                    } catch (InterruptedException e) {</span>
<span class="nc" id="L102">                        e.printStackTrace();</span>
                    }
<span class="nc" id="L104">                    creatureFactory.newDiamond(this.messages);</span>
                        }
        }
<span class="nc" id="L107">        ).start();</span>
<span class="nc" id="L108">    }</span>

    private void createWorld() {
<span class="nc" id="L111">        world = new WorldBuilder(30, 20).makeCaves().build();</span>
<span class="nc" id="L112">    }</span>

    private void displayTiles(AsciiPanel terminal, int left, int top) {
        // Show terrain
<span class="nc bnc" id="L116" title="All 2 branches missed.">        for (int x = 0; x &lt; screenWidth; x++) {</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            for (int y = 0; y &lt; screenHeight; y++) {</span>
<span class="nc" id="L118">                terminal.write((char)61, x, y, Color.gray);</span>
<span class="nc" id="L119">                int wx = x + left;</span>
<span class="nc" id="L120">                int wy = y + top;</span>
<span class="nc" id="L121">                    terminal.write(world.glyph(wx, wy), x, y, world.color(wx, wy));</span>
            }
        }
        // Show creatures
<span class="nc bnc" id="L125" title="All 2 branches missed.">        for (Creature creature : world.getCreatures()) {</span>
<span class="nc bnc" id="L126" title="All 6 branches missed.">            if (creature.x() &gt;= left &amp;&amp; creature.x() &lt; left + screenWidth &amp;&amp; creature.y() &gt;= top</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">                    &amp;&amp; creature.y() &lt; top + screenHeight) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if (player.canSee(creature.x(), creature.y())) {</span>
<span class="nc" id="L129">                    terminal.write(creature.glyph(), creature.x() - left, creature.y() - top);</span>
                }
            }
        }
        // Creatures can choose their next action now
<span class="nc" id="L134">        world.update();</span>
<span class="nc" id="L135">    }</span>

    private void displayMessages(AsciiPanel terminal, List&lt;String&gt; messages) {
<span class="nc bnc" id="L138" title="All 2 branches missed.">        for (int i = 0; i &lt; messages.size(); i++) {</span>
<span class="nc" id="L139">            terminal.write(messages.get(i), 1, this.screenHeight+i);</span>
        }
<span class="nc" id="L141">        this.oldMessages.addAll(messages);</span>
<span class="nc" id="L142">        messages.clear();</span>
<span class="nc" id="L143">    }</span>
<span class="nc" id="L144">        int shopCost=20;</span>
    @Override
    public Screen displayOutput(AsciiPanel terminal) {
        // Terrain and creatures
<span class="nc" id="L148">        displayTiles(terminal, getScrollX(), getScrollY());</span>
        // Player
<span class="nc" id="L150">        terminal.write(player.glyph(), player.x() - getScrollX(), player.y() - getScrollY());</span>
        // Stats
<span class="nc" id="L152">        String hpStat = String.format(&quot;%3d:%3d HP&quot;, player.hp(), player.maxHP());</span>
<span class="nc" id="L153">        terminal.write(hpStat, this.screenWidth+1, 15);</span>
<span class="nc" id="L154">        String expStat = String.format(&quot;%3d:%3d ExP&quot;, player.exp(),player.maxExp());</span>
<span class="nc" id="L155">        terminal.write(expStat, this.screenWidth+1, 16);</span>
<span class="nc" id="L156">        String attackStat = String.format(&quot;%3d ATTACK&quot;, player.attackValue());</span>
<span class="nc" id="L157">        terminal.write(attackStat, this.screenWidth+1, 17);</span>
<span class="nc" id="L158">        String defenseStat = String.format(&quot;%3d DEFENSE&quot;, player.defenseValue());</span>
<span class="nc" id="L159">        terminal.write(defenseStat, this.screenWidth+1, 18);</span>
<span class="nc" id="L160">        String moneyStat = String.format(&quot;%3d MONEY&quot;, player.money());</span>
<span class="nc" id="L161">        terminal.write(moneyStat, this.screenWidth+1, 19);</span>
        //Shop
<span class="nc" id="L163">        terminal.write(&quot;Shop&quot;,this.screenWidth+1,7);</span>
<span class="nc" id="L164">        String shopStat= String.format(&quot;PAY %s TO BUY&quot;,shopCost);</span>
<span class="nc" id="L165">        terminal.write(shopStat,this.screenWidth+1,8);</span>
<span class="nc" id="L166">        terminal.write(&quot;F1 ATTACK ADD 1&quot;,this.screenWidth+1,9);</span>
<span class="nc" id="L167">        terminal.write(&quot;F2 DEFENSE ADD 1&quot;,this.screenWidth+1,10);</span>
<span class="nc" id="L168">        terminal.write(&quot;F3 Hp add 300&quot;,this.screenWidth+1,11);</span>
<span class="nc" id="L169">        terminal.write(&quot;PRESS F4 &quot;,this.screenWidth+1,0);</span>
<span class="nc" id="L170">        terminal.write(&quot;TO SHOW NEARBY&quot;,this.screenWidth+1,1);</span>
<span class="nc" id="L171">        terminal.write(&quot;ENEMY DATA&quot;,this.screenWidth+1,2);</span>
<span class="nc" id="L172">        terminal.write(&quot;F5:SAVE&quot;,this.screenWidth+1,4);</span>
<span class="nc" id="L173">        terminal.write(&quot;F6:LOAD&quot;,this.screenWidth+1,5);</span>
        //Grade
<span class="nc" id="L175">        String Grade= String.format(&quot;GRADE %s&quot;,player.getGrade());</span>
<span class="nc" id="L176">        terminal.write(Grade,this.screenWidth+1,24);</span>
        // Messages
<span class="nc" id="L178">        displayMessages(terminal, this.messages);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        if(player.hp()&lt;=0){       </span>
<span class="nc" id="L180">            return new LoseScreen();</span>
        }
<span class="nc" id="L182">        return this;</span>
    }
    public void enemyAltras(){
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for(int i=-1;i&lt;=1;i++){</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            for(int j=-1;j&lt;=1;j++){</span>
<span class="nc bnc" id="L187" title="All 4 branches missed.">                if(!(i==0&amp;&amp;j==0)){</span>
<span class="nc" id="L188">                Creature other = world.creature(player.x() + i, player.y() + j);</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                    if (other == null) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                     } else if(other.ifDiamond()==false) {</span>
<span class="nc" id="L191">                    player.showEnemy(other);</span>
                    }
                }
            }
        }
<span class="nc" id="L196">    }</span>
    public void buyThing(int type){
<span class="nc bnc" id="L198" title="All 2 branches missed.">        if(player.money()&gt;=shopCost){</span>
<span class="nc" id="L199">            player.getMoney(-shopCost);</span>
<span class="nc bnc" id="L200" title="All 4 branches missed.">            switch (type){</span>
            case 1:
<span class="nc" id="L202">                player.modifyattackValue(1);</span>
<span class="nc" id="L203">                break;</span>
            case 2:
<span class="nc" id="L205">                player.modifydefenseValue(1);</span>
<span class="nc" id="L206">                break;</span>
            case 3:
<span class="nc" id="L208">                player.modifyHP(300);</span>
                break;
<span class="nc" id="L210">            }</span>
<span class="nc" id="L211">            shopCost+=4;</span>
        }
<span class="nc" id="L213">    }</span>
    public void savePlayerData(){
<span class="nc" id="L215">         saveHp=this.player.hp();</span>
<span class="nc" id="L216">         saveAttack=this.player.attackValue();</span>
<span class="nc" id="L217">         saveDefense=this.player.defenseValue();</span>
<span class="nc" id="L218">         saveExp=this.player.exp();</span>
<span class="nc" id="L219">         saveMoney=this.player.money();</span>
<span class="nc" id="L220">         saveX=this.player.x();</span>
<span class="nc" id="L221">         saveY=this.player.y();</span>
<span class="nc" id="L222">        this.player.notify(&quot;SAVE SUCESS&quot;);</span>
<span class="nc" id="L223">    }</span>
    public void loadPlayerData(){
<span class="nc" id="L225">        this.player.modifyHP(saveHp-this.player.hp());</span>
<span class="nc" id="L226">        this.player.modifyattackValue(saveAttack-this.player.attackValue());</span>
<span class="nc" id="L227">        this.player.modifydefenseValue(saveDefense-this.player.defenseValue());</span>
<span class="nc" id="L228">        this.player.getExp(saveExp-this.player.exp());</span>
<span class="nc" id="L229">       this.player.getMoney(saveMoney-this.player.money());</span>
<span class="nc" id="L230">        this.player.setX(saveX);</span>
<span class="nc" id="L231">        this.player.setY(saveY);</span>
<span class="nc" id="L232">        this.player.notify(&quot;LOAD SUCESS&quot;);</span>
<span class="nc" id="L233">    }</span>
    @Override
    public Screen respondToUserInput(KeyEvent key) {
<span class="nc bnc" id="L236" title="All 11 branches missed.">        switch (key.getKeyCode()) {</span>
            case KeyEvent.VK_LEFT:
<span class="nc" id="L238">                player.moveBy(-1, 0);</span>
<span class="nc" id="L239">                break;</span>
            case KeyEvent.VK_RIGHT:
<span class="nc" id="L241">                player.moveBy(1, 0);</span>
<span class="nc" id="L242">                break;</span>
            case KeyEvent.VK_UP:
<span class="nc" id="L244">                player.moveBy(0, -1);</span>
<span class="nc" id="L245">                break;</span>
            case KeyEvent.VK_DOWN:
<span class="nc" id="L247">                player.moveBy(0, 1);</span>
<span class="nc" id="L248">                break;</span>
            case KeyEvent.VK_F1:{
<span class="nc" id="L250">                this.buyThing(1);</span>
<span class="nc" id="L251">                this.player.notify(&quot;YOU BUY ATTACK&quot;);</span>
            
<span class="nc" id="L253">                break;}</span>
            case KeyEvent.VK_F2:{
<span class="nc" id="L255">                this.buyThing(2);</span>
<span class="nc" id="L256">                this.player.notify(&quot;YOU BUY DEFENSE&quot;);</span>
<span class="nc" id="L257">                break;</span>
            }
            case KeyEvent.VK_F3:{
<span class="nc" id="L260">                this.buyThing(3);</span>
<span class="nc" id="L261">                this.player.notify(&quot;YOU BUY HP&quot;);</span>
<span class="nc" id="L262">                break;</span>
        }
            case KeyEvent.VK_F4:
<span class="nc" id="L265">                this.enemyAltras();</span>
<span class="nc" id="L266">                break;</span>
            case KeyEvent.VK_F5:{
<span class="nc" id="L268">                world.save();</span>
<span class="nc" id="L269">                this.savePlayerData();</span>
<span class="nc" id="L270">                break;</span>
            }
            case KeyEvent.VK_F6:{
<span class="nc" id="L273">                world.load();</span>
<span class="nc" id="L274">                this.loadPlayerData();</span>
                break;
            }
        }
<span class="nc" id="L278">        return this;</span>
    }

    public int getScrollX() {
<span class="nc" id="L282">        return Math.max(0, Math.min(player.x() - screenWidth / 2, world.width() - screenWidth));</span>
    }

    public int getScrollY() {
<span class="nc" id="L286">        return Math.max(0, Math.min(player.y() - screenHeight / 2, world.height() - screenHeight));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>